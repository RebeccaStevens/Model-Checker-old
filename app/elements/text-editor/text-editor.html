<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/juicy-ace-editor/juicy-ace-editor.html">
<link rel="import" href="../../styles/shared-styles.html">

<!--
An element for accepting text content from the user.

Example:<br>

    <text-editor></text-editor>

@element text-editor
@demo text-editor/demo/index.html
-->
<dom-module id="text-editor">
  <style include="shared-styles"></style>
  <style>
    :host {
      display: block;
      position: relative;
    }
    paper-material {
      padding: 0;
      @apply(--layout-fit);
    }
    #jeditor {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }
  </style>
  <template>
    <paper-material id="frame">
      <template is="dom-bind" id="juicy-fixer">
        <juicy-ace-editor id="jeditor"
          on-change="_onCodeChanged"
          on-editor-ready="_onEditorReady"></juicy-ace-editor>
      </template>
    </paper-material>
  </template>
</dom-module>
<script>
  // jshint -W106
  (function() {
    Polymer({
      is: 'text-editor',

      /**
       * Fired when the code in the editor is changed.
       *
       * @event code-changed
       * @param {Event} originalEvent - the original change event that was fired.
       */

      properties: {
        /**
         * If true, the editor will be brought into focus automatically when the elements is attached to the dom.
         */
        autofocus: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        }
      },

      /**
       * Set the code in the editor.
       *
       * @param {!string} code - The code
       */
      setCode: function(code){
        this._skipNextCodeChangeEvent = true;
        this.$.jeditor.setValue(code, 1);
        this.fire('code-changed');
      },

      /**
       * Constructs and returns an annotation.
       *
       * @param {!integer} line - the line number to put annotation on
       * @param {!string} text - the text to put in the annotation
       * @param {!string} type - the type of annotation to place
       * @returns {!object} - an annotation object
       */
      constructAnnotation: function(line, text, type) {
        var annotation = {
          row: line,
          column: 2,
          text: text,
          type: type
        };

        return annotation;
      },

      /**
       * Sets the annotations of the editor to those specified in the array.
       *
       * @param {!array} annotations - an array of annotations
       */
      setAnnotations: function(annotations) {
        this.$.jeditor.session.setAnnotations(annotations);
      },

      /**
       * Bring this element into focus
       */
      focus: function() {
        if (this.$.jeditor.editor) {
          this.$.jeditor.editor.focus();
        }
      },

      /**
       * Called when the element has been created, but before property values are set and local DOM is initialized.
       */
      created: function() {

        // Define `this.code`
        // Defined here instead of in the properties object as we want control over the getter and setter

        /**
         * The code in the editor.
         *
         * @type {String}
         */
        Object.defineProperty(this, 'code', {
          get: function() {
            return this.$.jeditor.value;
          },
          set: function(val) {
            this.$.jeditor.value = val;
            this.$.jeditor.editor.clearSelection();
            this.$.jeditor.editor.navigateFileEnd();
            return val;
          }
        });
      },

      ready: function() {
        // there's a bug with adding the <juicy-ace-editor> straight into the dom as normal
        // `juicy-fixer` is a work around for it
        this.$.jeditor = this.$['juicy-fixer'].$.jeditor;
        this.$['juicy-fixer']._onEditorReady = this._onEditorReady.bind(this);
        this.$['juicy-fixer']._onCodeChanged = this._onCodeChanged.bind(this);
      },

      /**
       * Called when the code in the editor changes.
       */
      _onCodeChanged: function(e) {
        this.fire('code-changed', {originalEvent: e});
      },

      /**
       * Called when the editor is ready.
       */
      _onEditorReady: function() {
        // for some reason `this.$.jeditor.editor` is not defined yet so wait a bit until it is
        this.async(function() {
          this.$.jeditor.editor.$blockScrolling = Infinity;   // disable warning messgae

          // if this should autofocus, wait 100ms then do it
          if (this.autofocus) {
            this.async(function() {
              this.focus();
            }, 100);
          }
        });
      }
    });
  })();
</script>
