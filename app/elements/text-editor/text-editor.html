<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../imports/ace.html">

<!--
An element for accepting text content from the user.

Example:<br>

    <text-editor>console.log("Example of initial code.");</text-editor>

### Styling

The following custom properties and mixins are available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--text-editor` | A mixin applied to the editor | `{}`

@element text-editor
@demo text-editor/demo/index.html
-->
<dom-module id="text-editor">
  <style include="shared-styles"></style>
  <style>
    :host {
      display: block;
      position: relative;
    }
    paper-material {
      padding: 0;
      @apply(--layout-fit);
    }
    #editor {
      box-sizing: border-box;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      @apply(--text-editor);
    }
  </style>
  <template>
    <paper-material>
      <div id="editor"></div>
    </paper-material>
  </template>
</dom-module>
<script>
  // jshint -W106
  (function() {
    Polymer({
      is: 'text-editor',

      /**
       * Fired when the text in the editor is changed.
       *
       * @event code-changed
       */

      properties: {
        /**
         * The code in the editor.
         */
        code: String,

        /**
         * The size of tabs.
         *
         * @default 4
         */
        tabSize: Boolean,

        /**
         * If true the editor will be brought into focus automatically when the elements is attached to the dom.
         */
        autofocus: {
          type: Boolean,
          value: false
        },

        /**
         * The ace theme to use.
         */
        theme: {
          type: String
        },

        /**
         * The ace mode to use.
         */
        mode: {
          type: String,
          value: 'ace/mode/text'
        },

        /**
         * The font size to use.
         */
        fontsize: {
          type: Number,
          value: 14
        },

        /**
         * if true, softtabs will be used.
         */
        softtabs: {
          type: Boolean,
          value: false
        },

        /**
         * The code can't be edited by the user.
         */
        readonly: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        /**
         * If true, text will be wrapped to the next line if it is too long.
         */
        wrap: {
          type: Boolean,
          value: false
        },

        /**
         * The ace editor object
         */
        _editor: Object,

        /**
         * This stores the `code` before the ace text editor is ready
         */
        _initialCode: {
          type: String,
          value: function() {
            return this.textContent.trim();
          }
        },

        /**
         * This initial tab size.
         */
        _initialTabSize: {
          type: String,
          value: 4
        },

        /**
         * Set to true once the editor has been initialized.
         */
        _initialized: {
          type: Boolean,
          value: false
        }
      },

      /**
       * Constructs and returns an annotation.
       *
       * @param {!integer} line - the line number to put annotation on
       * @param {!string} text - the text to put in the annotation
       * @param {!string} type - the type of annotation to place
       * @returns {!object} - an annotation object
       */
      constructAnnotation: function(line, text, type) {
        var annotation = {
          row: line,
          column: 2,
          text: text,
          type: type
        };

        return annotation;
      },

      /**
       * Sets the annotations of the editor to those specified in the array.
       *
       * @param {!array} annotations - an array of annotations
       */
      setAnnotations: function(annotations) {
        this._editor.session.setAnnotations(annotations);
      },

      /**
       * Bring this element into focus
       */
      focus: function() {
        this._editor.focus();
      },

      /**
       * Called when the element has been created, but before property values are set and local DOM is initialized.
       */
      created: function() {

        var initCode = this.getAttribute('code'); // get any initial code given as an attribute

        // if there is some initCode
        if (initCode) {
          var escapeRegExp = function(str) {
            return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, '\\$1');
          };

          var replaceAll = function(str, find, replace) {
            return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);
          };

          // set `_initialCode` to in - replace special characters
          this._initialCode = replaceAll(replaceAll(initCode,
              '\\n', '\n'),
              '\\t', '\t');
        }

        var initTabSize = this.getAttribute('tab-size'); // get any initial tab size given as an attribute

        // if there an initial tab size
        if (initTabSize) {
          this._initialTabSize = initTabSize;
        }

        // Define `this.code`'s getter and setter.
        // This will override the code property defined in the properties object.
        Object.defineProperty(this, 'code', {
          get: function() {
            if (this._initialized) {
              return this._editor.getValue();
            }
            return this._initialCode;
          },
          set: function(val) {
            if (this._initialized) {
              return this._editor.setValue(val, 1);
            }
            this._initialCode = val;
            return this._initialCode;
          }
        });

        // Define `this.tabSize`'s getter and setter.
        // This will override the tabSize property defined in the properties object.
        Object.defineProperty(this, 'tabSize', {
          get: function() {
            if (this._initialized) {
              return this._editor.getSession().getTabSize();
            }
            return this._initialTabSize;
          },
          set: function(val) {
            if (this._initialized) {
              return this._editor.getSession().setTabSize(val);
            }
            this._initialTabSize = val;
            return this._initialTabSize;
          }
        });
      },

      /**
       * Called after property values are set and local DOM is initialized.
       */
      ready: function() {
        this._editor = ace.edit(this.$.editor); // turn `this.$.editor` into a text editor
      },

      /**
       * Called after the element is attached to the document.
       */
      attached: function() {
        this._initializeEditor();

        if (this.autofocus) {
          this.async(function() {
            this.focus();
          }, 100);
        }

        // call attributeChanged with the initial value of each attribute (so long as it is defined)
        ['theme', 'mode', 'fontsize', 'softtabs', 'tabsize', 'readonly', 'wrap'].forEach(function(e) {
          if (this[e] !== undefined) {
            this.attributeChanged(e, undefined, this[e]);
          }
        }.bind(this));
      },

      /**
       * Called when one of the element's attributes is changed.
       */
      attributeChanged: function(attr, oldVal, newVal) {
        if (!this.isAttached) {
          return false;
        }
        switch (attr) {
          case 'theme':
            this._editor.setTheme(newVal);
            this._injectTheme(newVal);
            break;
          case 'mode':
            this._editor.getSession().setMode(newVal);
            break;
          case 'fontsize':
            this._editor.setFontSize(Number.parseInt(newVal, 10));
            break;
          case 'softtabs':
            this._editor.getSession().setUseSoftTabs(newVal);
            break;
          case 'tabsize':
            this._editor.getSession().setTabSize(Number.parseInt(newVal, 10));
            break;
          case 'readonly':
            this._editor.setReadOnly(newVal);
            break;
          case 'wrap':
            this._editor.getSession().setUseWrapMode(newVal);
            break;
        }
      },

      /**
       * Initialize the editor.
       */
      _initializeEditor: function() {
        this._initialized = true;    // editor has been initialized - this line needs to be before the line "code = ..."
        this._editor.$blockScrolling = Infinity;   // disable scrolling warning messgae

        // ace.config.set('basePath', this.resolveUrl('../ace-builds/src-min-noconflict/'));

        // fire a 'code-changed' event when the text editor's content changes
        this._editor.addEventListener('change', function(e) {
          this.fire('code-changed', {originalEvent: e});
        }.bind(this));

        this.code = this._initialCode;
        this.tabSize = this._initialTabSize;

        // if we are using the shadow dom (not the shady dom)
        if (Polymer.Settings.useShadow) {
          // we need to copy the stylings from the main document to this element's shadow root
          // as ace is putting its stylings in the wrong place
          this.shadowRoot.appendChild(this._cloneStyle(document.getElementById('ace_editor.css')));
          this.shadowRoot.appendChild(this._cloneStyle(document.getElementById('ace-tm')));
        }
      },

      /**
       * Inject an ace theme style into this element.
       *
       * @param {!String} theme - the name/path of the ace theme to use
       */
      _injectTheme: function(theme) {
        // this is only needed when using the shadow dom (not the shady dom)
        if (Polymer.Settings.useShadow) {
          var id = 'ace-' + theme.substring(theme.lastIndexOf('/') + 1);  // the id of this theme

          // does the element already have this theme style loaded?
          if (Polymer.dom(this).querySelector('#' + id) !== null) {
            return;   // if so, we don't need to do any thing else
          }

          var style = document.getElementById(id);  // does the style element aready exist in the document

          // if so, simply copy it
          if (style) {
            this.shadowRoot.appendChild(this._cloneStyle(style));
          }
          // if not, wait until it does then copy it
          else {
            var copyTheme = function(e) {
              if (e.srcElement.id === id) {
                this.shadowRoot.appendChild(this._cloneStyle(e.srcElement));
                document.head.removeEventListener('DOMNodeInserted', copyTheme, false);
              }
            }.bind(this);

            // wait until the theme is injected into the head, then copy it to this element
            document.head.addEventListener('DOMNodeInserted', copyTheme, false);
          }
        }
      },

      /**
       * Helper function to clone a style tag.
       *
       * @param {!HTMLStyleElement} style - the style element to copy
       */
      _cloneStyle: function(style) {
        var s = document.createElement('style');
        s.id = style.id;
        s.textContent = style.textContent;
        return s;
      }
    });
  })();
</script>
